#!/usr/bin/env bash
# shellcheck disable=SC2034
# Combined with a cron job, this script downloads random photos from picsum. a random file is choosen if no connectivity is found.
# https://github.com/BreadOnPenguins/scripts/issues/13

set -euo pipefail

SEARCH="${1:-wallpaper desktop}"
SRC="https://picsum.photos"
DEST="/home/$USER/Pictures/wallpaper"
BRIGHTNESS=100

CURRENT_DESKTOP=$(pgrep -x -i "xfce|dwm|hyprland" | head -n1 || echo "")

ERROR=$(curl -s "$SRC/200/300?grayscale" || echo "")

check_connectivity() {
    if [[ -n "${ERROR:-}" ]]; then
        echo -e "$SRC unavailable.\nWill pick a random image from your Pictures folder"
    fi
    if [ "$(nmcli networking connectivity)" != "full" ]; then
        exit 1
    fi
}

get_colortemp() {
    local img="$1"
    local light dark
    read -r light dark < <(convert "$img" -format "%[fx:meanwh] %[fx:(1-mean)wh]" info:)
    light=$(echo "$light" | awk -F"E" 'BEGIN{OFMT="%10.10f"} {print $1 * (10 ^ $2)}')
    dark=$(echo "$dark" | awk -F"E" 'BEGIN{OFMT="%10.10f"} {print $1 * (10 ^ $2)}')
    brightness=$(echo "100*$light/$dark" | bc)
    echo "$brightness"
}

set_wallpaper() {
    local search="${SEARCH// /+}"
    local xfeh
    xfeh=$(xrandr --listactivemonitors | sed '1d' | while read -r line; do
        local resolution display
        read -r resolution display < <(awk '{print $3, $4}' <<<"$line")
        resolution=$(sed -e 's//.x/x/' -e 's//.//' <<<"$resolution")
        resolution_bis=$(echo "$resolution" | sed 's/x///')
        local link="$SRC/${resolution_bis}"
        local img="$DEST/xwallpaper-$resolution-$display.jpg"
        echo "$link $img" >/tmp/xrand-wallpaper.log
        
        if [[ -n "${ERROR:-}" ]]; then
            img=$(shuf -n 1 -e "$DEST"/*.jpg)
        else
            local brightness=500
            while [ "$brightness" -gt "$BRIGHTNESS" ]; do
                wget -q -O "$img" "$link"
                brightness=$(get_colortemp "$img")
                sleep 1
            done
        fi
        
        case "$CURRENT_DESKTOP" in
            xfce)
                for monitor in $(xfconf-query -c xfce4-desktop -p /backdrop -l | grep -E -e "$display.last-image$"); do
                    xfconf-query -c xfce4-desktop -p "$monitor" -s "$img"
                done
                ;;
            dwm)
                xfeh="$xfeh $img "
                echo "$xfeh"
                ;;
            hyprland)
                # For Hyprland, we'll use hyprpaper if available, otherwise fallback to swaybg
                if command -v hyprpaper >/dev/null 2>&1; then
                    hyprpaper -i "$display:$img" >/dev/null 2>&1 &
                elif command -v swaybg >/dev/null 2>&1; then
                    swaybg -i "$img" -m fill &
                fi
                ;;
        esac
    done | tail -1)
    
    if [[ -n "${xfeh:-}" ]]; then
        feh --bg-scale "$xfeh"
    fi
}

check_connectivity
set_wallpaper